<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Lista Prenotazioni</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
</head>
<body>
  <div class="sidebar">
    <h2>Gestione Affitti</h2>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="lista_prenotazioni.html">Prenotazioni</a></li>
      <li><a href="lista_movimenti.html">Movimenti</a></li>
    </ul>
  </div>
  <div class="main">
    <div class="topbar">
      <span class="account">Account</span>
    </div>
    <div class="content">
      <h1>Lista Prenotazioni</h1>
      <button class="btn" onclick="carica()">Aggiorna Tabella</button>
      <div id="tabella">Caricamento in corso...</div>
    </div>
  </div>
  <script>
    const URL_BASE = "https://script.google.com/macros/s/AKfycbyOt1OlCuLq0DsWsc0l2PvMGrZUZTbEu2C0bY7G5Tz6M4uZzF_UPJo94vSS8V1CM1xv/exec";

    let dataTable;

    function formatDate(value) {
      const d = new Date(value);
      if (isNaN(d)) return value ?? '';
      return d.toLocaleDateString('it-IT');
    }

    function formatCurrency(value) {
      const num = parseFloat(value);
      if (isNaN(num)) return '';
      return num.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' \u20AC';
    }

    async function carica() {
      try {
        const res = await fetch(`${URL_BASE}?foglio=PRENOTAZIONI`);
        const data = await res.json();

        const headers = data[0];
        const dateCols = [];
        const amountCols = [];
        let idxStato = -1;

        headers.forEach((h, i) => {
          const lc = h.toLowerCase();
          if (lc.includes('data') || lc.includes('check')) dateCols.push(i);
          if (['totale','tasse','netto','importo','costo','prezzo','canone','pulizia','incassato'].some(k => lc.includes(k))) {
            amountCols.push(i);
          }
          if (lc.includes('stato')) idxStato = i;
        });

        let html = '<table id="prenotazioni"><thead><tr>';
        headers.forEach(col => html += `<th>${col}</th>`);
        html += '</tr></thead><tbody>';

        data.slice(1).forEach(row => {
          const canc = idxStato >= 0 && (row[idxStato] || '').toString().toUpperCase() === 'CANCELLATA';
          html += `<tr${canc ? ' class="cancellata"' : ''}>`;
          row.forEach((cell, j) => {
            let content = cell ?? '';
            let cls = '';
            if (content === '#VALUE!') content = '';
            if (dateCols.includes(j)) {
              content = formatDate(content);
            } else if (amountCols.includes(j)) {
              content = formatCurrency(content);
              cls = 'importo';
            }
            html += `<td${cls ? ` class="${cls}"` : ''}>${content}</td>`;
          });
          html += '</tr>';
        });
        html += '</tbody></table>';

        document.getElementById('tabella').innerHTML = html;

        if (dataTable) {
          dataTable.destroy();
        }

        $('#prenotazioni thead tr').clone(true).appendTo('#prenotazioni thead');

        dataTable = $('#prenotazioni').DataTable({
          orderCellsTop: true,
          fixedHeader: true
        });

        $('#prenotazioni thead tr:eq(1) th').each(function (i) {
          const title = $(this).text();
          $(this).html('<input type="text" placeholder="Filtra ' + title + '" />');

          $('input', this).on('keyup change', function () {
            if (dataTable.column(i).search() !== this.value) {
              dataTable
                .column(i)
                .search(this.value)
                .draw();
            }
          });
        });
      } catch (error) {
        document.getElementById('tabella').innerHTML = `<p style='color:red;'>Errore: ${error}</p>`;
        console.error('Errore fetch:', error);
      }
    }

    document.addEventListener("DOMContentLoaded", carica);
  </script>
</body>
</html>
