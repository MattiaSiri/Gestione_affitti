<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <div class="sidebar">
    <h2>Gestione Affitti</h2>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="lista_prenotazioni.html">Prenotazioni</a></li>
      <li><a href="lista_movimenti.html">Movimenti</a></li>
    </ul>
  </div>
  <div class="main">
    <div class="topbar">
      <span class="account">Account</span>
    </div>
    <div class="content">
      <h1 class="page-title">Gestione Affitti</h1>
      <div class="stats">
        <div class="stat-card prenotazioni">
          <i class="fa-solid fa-calendar-check stat-icon"></i>
          <div class="stat-info">
            <h3>Prenotazioni</h3>
            <p id="totPren">-</p>
          </div>
        </div>
        <div class="stat-card entrate">
          <i class="fa-solid fa-euro-sign stat-icon"></i>
          <div class="stat-info">
            <h3>Entrate</h3>
            <p id="totEntrate">-</p>
          </div>
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="lista_prenotazioni.html">Lista Prenotazioni</a>
        <a class="btn" href="lista_movimenti.html">Lista Movimenti</a>
      </div>
      <div class="card" id="checkin-card">
        <h2>ðŸ“… Prossimi Check-in</h2>
        <button class="btn" onclick="caricaDashboard()">Aggiorna</button>
        <div id="dashboard">Caricamento in corso...</div>
      </div>
    </div>
  </div>
  <script>
    const URL_BASE = "https://script.google.com/macros/s/AKfycbyOt1OlCuLq0DsWsc0l2PvMGrZUZTbEu2C0bY7G5Tz6M4uZzF_UPJo94vSS8V1CM1xv/exec";

    function parseDate(iso) {
      return new Date(iso);
    }

    function formatDate(iso) {
      const d = parseDate(iso);
      if (isNaN(d)) return '';
      return d.toLocaleDateString('it-IT');
    }

    async function caricaStatistiche() {
      try {
        const prenRes = await fetch(`${URL_BASE}?foglio=PRENOTAZIONI`);
        const prenData = await prenRes.json();
        document.getElementById('totPren').textContent = prenData.length - 1;

        const movRes = await fetch(`${URL_BASE}?foglio=MOVIMENTI`);
        const movData = await movRes.json();
        const idxImp = movData[0].indexOf('Importo');
        const totale = movData.slice(1).reduce((sum, r) => sum + parseFloat(r[idxImp] || 0), 0);
        document.getElementById('totEntrate').textContent = totale.toFixed(2);
      } catch (e) {
        console.error('Errore statistiche:', e);
      }
    }

    async function caricaDashboard() {
      try {
        const res = await fetch(`${URL_BASE}?foglio=PRENOTAZIONI`);
        const data = await res.json();

        const headers = data[0];
        const rows = data.slice(1);

        const idxApp = headers.indexOf('Appartamento');
        const idxNome = headers.indexOf('Nome e Cognome');
        const idxIn = headers.indexOf('Check-in');
        const idxOut = headers.indexOf('Check-out');

        const now = new Date();
        const limit = new Date();
        limit.setDate(limit.getDate() + 30);

        const filtered = rows.filter(row => {
          const dateStr = row[idxIn];
          if (!dateStr) return false;
          const dt = parseDate(dateStr);
          return dt >= now && dt <= limit;
        });

        let html = '<table><thead><tr>' +
          '<th>Appartamento</th><th>Nome e Cognome</th><th>Check-in</th><th>Check-out</th>' +
          '</tr></thead><tbody>';
        filtered.forEach(row => {
          html += '<tr>' +
            `<td>${row[idxApp] ?? ''}</td>` +
            `<td>${row[idxNome] ?? ''}</td>` +
            `<td>${formatDate(row[idxIn])}</td>` +
            `<td>${formatDate(row[idxOut])}</td>` +
            '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('dashboard').innerHTML = html || '<p>Nessun arrivo prossimo.</p>';
      } catch (error) {
        document.getElementById('dashboard').innerHTML = `<p style="color:red;">Errore: ${error}</p>`;
        console.error('Errore fetch:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      caricaDashboard();
      caricaStatistiche();
    });
  </script>
</body>
</html>
