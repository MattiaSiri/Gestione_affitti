<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Prossimi Check-in</h1>
  <div class="card">
    <button onclick="caricaDashboard()">Aggiorna</button>
    <div id="dashboard">Caricamento in corso...</div>
  </div>

  <script>
    const URL_BASE = "https://script.google.com/macros/s/AKfycbyOt1OlCuLq0DsWsc0l2PvMGrZUZTbEu2C0bY7G5Tz6M4uZzF_UPJo94vSS8V1CM1xv/exec";

    function parseDate(itDate) {
      const [d, m, y] = itDate.split('/').map(Number);
      return new Date(y, m - 1, d);
    }

    async function caricaDashboard() {
      try {
        const res = await fetch(`${URL_BASE}?foglio=PRENOTAZIONI`);
        const data = await res.json();

        const headers = data[0];
        const rows = data.slice(1);

        const idxApp = headers.indexOf('Appartamento');
        const idxNome = headers.indexOf('Nome e Cognome');
        const idxIn = headers.indexOf('Check-in');
        const idxOut = headers.indexOf('Check-out');

        const now = new Date();
        const limit = new Date();
        limit.setDate(limit.getDate() + 30);

        const filtered = rows.filter(row => {
          const dateStr = row[idxIn];
          if (!dateStr) return false;
          const dt = parseDate(dateStr);
          return dt >= now && dt <= limit;
        });

        let html = '<table><thead><tr>' +
          '<th>Appartamento</th><th>Nome e Cognome</th><th>Check-in</th><th>Check-out</th>' +
          '</tr></thead><tbody>';
        filtered.forEach(row => {
          html += '<tr>' +
            `<td>${row[idxApp] ?? ''}</td>` +
            `<td>${row[idxNome] ?? ''}</td>` +
            `<td>${row[idxIn] ?? ''}</td>` +
            `<td>${row[idxOut] ?? ''}</td>` +
            '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('dashboard').innerHTML = html || '<p>Nessun arrivo prossimo.</p>';
      } catch (error) {
        document.getElementById('dashboard').innerHTML = `<p style='color:red;'>Errore: ${error}</p>`;
        console.error('Errore fetch:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', caricaDashboard);
  </script>
</body>
</html>
